<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.ie.css" />
    <![endif]-->
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
    <script src="data/overpassData.js"></script>
    <script src="data/extraPubsData.js"></script>
    <script src="data/visitData.js"></script>
    <style type="text/css">
        body { padding:0; margin:0; }
        html, body, #map { height: 100%; }
        #message { position: absolute; top:0px; right:0px; background-color: white; padding:0 4px 2px; text-align:right; }
    </style>
    <script type="text/javascript">

        // Set these up later on on body load.
        var todoIcon;
        var doneIcon;
        var excludedIcon;

        function createMap(lat, lon)
        {
            var map = L.map('map').setView([lat, lon], 13);
            var osmAttr = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: osmAttr
            }).addTo(map);
            return map;
        }

        function postLink(pub)
        {
            var text = pub.name;
            if ("link" in pub && pub.link != "")
                text = "<a href=\"http://brewmook.wordpress.com" + pub.link + "\">" + pub.name + "</a>";
            if ("statusinfo" in pub && pub.statusinfo != undefined)
                text += "<br/><em>" + pub.statusinfo + "</em>";
            return text;
        }

        function pubIcon(pub)
        {
            if (pub.status == "done")
                return doneIcon;
            if (pub.status == "disqualified" || pub.status == "closed")
                return excludedIcon;
            return todoIcon;
        }

        function addFlag(layer, pub)
        {
            var marker = L.marker([pub.lat, pub.lon],
                                  { "title": pub.name,
                                    "icon": pubIcon(pub) });
            marker.addTo(layer);
            marker.bindPopup(postLink(pub));
        }

        function displayTotals(donePubs, todoPubs)
        {
            var done = donePubs.length;
            var total = done + todoPubs.length;
            $('#message').html(
                "Total " + total + " pubs<br/>"
                + done + " done<br/>"
                + Math.round((done/total)*100) + "% complete");
        }

        function addTargetToMap(target, map)
        {
            var circle = new L.circle([target.lat, target.lon],
                                      target.radiusMetres,
            {
                color: '#c80',
                fillColor: '#fc4',
                fillOpacity: 0.15,
            });
            map.addLayer(circle);
        }

        function setupIcons()
        {
            // Setup icons
            var Icon = L.Icon.extend({
                options: {
                    iconSize: [25, 39],
                    iconAnchor:   [12, 36],
                    popupAnchor: [0, -30]
                }
            });
            todoIcon = new Icon({ iconUrl: "img/marker-gold.png", iconRetinaUrl: "img/marker-gold-2x.png" });
            doneIcon = new Icon({ iconUrl: "img/marker-blue.png", iconRetinaUrl: "img/marker-blue-2x.png" });
            excludedIcon = new Icon({ iconUrl: "img/marker-red.png", iconRetinaUrl: "img/marker-red-2x.png" });
        }

        function getVisitData(visitData)
        {
            var result = {};
            for (var i in visitData)
            {
                result[visitData[i][0]] = {"name":   visitData[i][1],
                                           "status": visitData[i][2].split(":")[0],
                                           "statusinfo": visitData[i][2].split(":")[1],
                                           "link":   visitData[i][3]};
            }
            return result;
        }

        function mergeVisitData(visitData, pub)
        {
            if (pub.id in visitData)
            {
                pub.status = visitData[pub.id].status;
                pub.statusinfo = visitData[pub.id].statusinfo;
                pub.name = visitData[pub.id].name;
                pub.link = visitData[pub.id].link;
            }
            return pub;
        }

        function dictionaryToArray(dictionary)
        {
            var result = [];
            for (var i in dictionary) {
                result.push(dictionary[i]);
            }
            return result;
        }

        function getPubs()
        {
            var dictionary = {};
            var allPubs = overpassData.concat(extraPubsData);
            var visitData = getVisitData(visitDataArray);

            for (var i in allPubs)
            {
                var pub = mergeVisitData(visitData, allPubs[i]);
                dictionary[pub.id] = pub;
            }

            return dictionaryToArray(dictionary);
        }

        function filterByStatus(pubs, statuses)
        {
            return pubs.filter(function(pub) {
                return statuses.some(function(status) { return status == pub.status; });
            });
        }

        function addPubsAsLayer(pubs, layerName, map, layersControl)
        {
            var layer = new L.LayerGroup().addTo(map);
            pubs.forEach(function(pub) {
                addFlag(layer, pub);
            });
            layersControl.addOverlay(layer, layerName + ": " + pubs.length);
        }

        function initialiseMap()
        {
            var target = { lat:55.94816654144937,
                           lon:-3.1994622945785522,
                           radiusMetres:1609 };
            var map = createMap(target.lat, target.lon);
            var layersControl = L.control.layers(null, null, { "position":"bottomright", "collapsed": false }).addTo(map);

            addTargetToMap(target, map);
            setupIcons();

            var allPubs = getPubs();

            var donePubs = filterByStatus(allPubs, ["done"]);
            addPubsAsLayer(donePubs, "Done (blue)", map, layersControl);

            var todoPubs = filterByStatus(allPubs, [undefined]);
            addPubsAsLayer(todoPubs, "Todo (yellow)", map, layersControl);

            var excludedPubs = filterByStatus(allPubs, ["closed","disqualified"]);
            addPubsAsLayer(excludedPubs, "Excluded (red)", map, layersControl);

            displayTotals(donePubs, todoPubs);
        }
    </script>
</head>
<body onload="initialiseMap()">
  <div id="map"></div>
  <div id="message">Fetching data...</div>
</body>
</html>
